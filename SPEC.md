# Issue #110: 習慣の実施曜日・実施時間を設定し「今日の習慣」に反映する

## 最終仕様書

---

## 1. 背景 / 目的

- ユーザーが習慣（薬/サプリ等）ごとに「いつやるか（曜日・時刻）」を設定できるようにする
- 設定内容をもとに「今日の習慣」画面で、今日やるべき習慣が自然に分かる状態にする
- MVPの体験を崩さず、あとから拡張できる設計に寄せる

## 2. 用語定義

| 用語 | 説明 |
|------|------|
| Habit | 習慣（薬/サプリ/行動） |
| HabitLog | 当日の実施記録（ワンタップで作る） |
| 今日の習慣 | 今日実施すべき Habit を一覧表示する画面/機能 |
| 時刻 | HH:MM 形式の具体的な実施予定時刻 |
| 実施曜日 | 習慣を実施する曜日（複数選択可） |

---

## 3. 現状分析

### 3.1 「今日の習慣」画面の現状
- **状態**: 未実装（プレースホルダー表示）
- ルート定義済み: `GET /todays_habits`
- コントローラーアクション未実装

### 3.2 現在の日付判定
- `log_date` カラムで判定（`Date.current` ベース）
- タイムゾーン: `Asia/Tokyo` 固定

### 3.3 1日複数回記録
- **不可**（DBユニーク制約: `user_id, habit_id, log_date`）
- この制約は維持する

### 3.4 現在の並び順
- `created_at: :asc`（作成日の古い順）

---

## 4. 確定仕様

### 4.1 実施曜日

| 項目 | 仕様 |
|------|------|
| データ型 | PostgreSQL 配列カラム（integer[]） |
| 値の表現 | 0=日曜, 1=月曜, 2=火曜, ... 6=土曜 |
| 未設定時の挙動 | **毎日扱い**（全曜日選択と同等） |
| 空配列の挙動 | **毎日扱い**（全曜日選択と同等） |

### 4.2 実施時刻

| 項目 | 仕様 |
|------|------|
| データ型 | `time` 型（HH:MM:SS、秒は00固定） |
| 必須/任意 | **任意**（NULL許可） |
| 粒度 | **30分刻み**（00分 / 30分） |
| 未設定時の並び順 | 時刻設定ありの習慣の後に表示 |

### 4.3 「今日の習慣」表示ロジック

#### 表示条件
```
今日の曜日 ∈ 習慣の設定曜日（または曜日未設定）
```

#### セクション構成
1. **未完了セクション**: 今日まだ記録していない習慣
2. **完了セクション**: 今日記録済みの習慣

#### 並び順
```
1. 時刻設定あり → 時刻の昇順（早い順）
2. 時刻設定なし → 作成日の昇順
```

#### 記録の取り消し
- **可能**: 完了セクションの習慣をタップすると未完了に戻る

---

## 5. UI/UX 仕様

### 5.1 曜日選択 UI

```
┌─────────────────────────────────────────────────┐
│ 実施曜日                                         │
├─────────────────────────────────────────────────┤
│ [毎日] [平日] [週末]          ← プリセットボタン  │
│                                                 │
│ [月] [火] [水] [木] [金] [土] [日]  ← トグル     │
│  ●    ●    ●    ●    ●    ○    ○               │
└─────────────────────────────────────────────────┘
● = 選択中、○ = 未選択
```

**プリセットボタン動作**:
- `毎日`: 全曜日を選択/解除のトグル
- `平日`: 月〜金を選択（土日は解除）
- `週末`: 土日を選択（月〜金は解除）

### 5.2 時刻選択 UI

```
┌─────────────────────────────────────────────────┐
│ 実施時刻（任意）                                  │
├─────────────────────────────────────────────────┤
│ [時間 ▼] : [分 ▼]                               │
│                                                 │
│ 時間: 0〜23（24選択肢）                          │
│ 分: 00, 30（2選択肢）                            │
│                                                 │
│ [× クリア] ← 時刻設定を削除                      │
└─────────────────────────────────────────────────┘
```

### 5.3 「今日の習慣」画面 UI

```
┌─────────────────────────────────────────────────┐
│ 今日の習慣                          2026/01/26   │
├─────────────────────────────────────────────────┤
│                                                 │
│ ── 未完了 (2件) ──                              │
│                                                 │
│ ┌─────────────────────────────────────────────┐ │
│ │ 08:00  ビタミンC              [記録する]     │ │
│ └─────────────────────────────────────────────┘ │
│ ┌─────────────────────────────────────────────┐ │
│ │ 21:00  就寝前の薬             [記録する]     │ │
│ └─────────────────────────────────────────────┘ │
│                                                 │
│ ── 完了済み (1件) ──                            │
│                                                 │
│ ┌─────────────────────────────────────────────┐ │
│ │ ✓ 12:00  昼の薬               [取り消す]    │ │
│ └─────────────────────────────────────────────┘ │
│                                                 │
└─────────────────────────────────────────────────┘
```

**時刻未設定の習慣**:
- 時刻欄は「--:--」または空白で表示
- 時刻設定ありの習慣の後に並ぶ

---

## 6. データ設計

### 6.1 habits テーブルへの追加カラム

```ruby
# マイグレーション
add_column :habits, :schedule_days, :integer, array: true, default: []
add_column :habits, :scheduled_time, :time

add_index :habits, :schedule_days, using: :gin
```

| カラム名 | 型 | デフォルト | 説明 |
|----------|-----|------------|------|
| schedule_days | integer[] | [] | 実施曜日（0-6の配列） |
| scheduled_time | time | NULL | 実施時刻 |

### 6.2 既存データの移行

```ruby
# 既存の習慣は全曜日選択扱い（空配列のまま）
# アプリケーションロジックで空配列 = 毎日と解釈
# 時刻は NULL のまま
```

### 6.3 モデル変更

```ruby
# app/models/habit.rb

class Habit < ApplicationRecord
  # 既存のコード...

  # 定数
  WEEKDAYS = (1..5).to_a.freeze  # 月〜金
  WEEKENDS = [0, 6].freeze        # 日、土
  ALL_DAYS = (0..6).to_a.freeze   # 全曜日

  # スコープ: 指定日に実施すべき習慣
  scope :scheduled_for, ->(date) {
    wday = date.wday
    where("schedule_days = '{}' OR ? = ANY(schedule_days)", wday)
  }

  # スコープ: 時刻順（NULL は後ろ）
  scope :ordered_by_time, -> {
    order(Arel.sql("scheduled_time IS NULL, scheduled_time ASC, created_at ASC"))
  }

  # 曜日が設定されているか
  def schedule_days_set?
    schedule_days.present?
  end

  # 指定日に実施すべきか
  def scheduled_on?(date)
    return true if schedule_days.blank?
    schedule_days.include?(date.wday)
  end
end
```

---

## 7. コントローラー実装

### 7.1 PagesController#todays_habits

```ruby
# app/controllers/pages_controller.rb

def todays_habits
  today = Date.current

  # 今日実施すべき習慣を取得
  habits = current_user.habits
    .scheduled_for(today)
    .active_on(today)
    .ordered_by_time
    .includes(:habit_logs)

  # 今日のログを一括取得（N+1対策）
  today_logs = current_user.habit_logs
    .where(habit: habits, log_date: today)
    .index_by(&:habit_id)

  # 完了/未完了に分類
  @incomplete_habits = []
  @completed_habits = []

  habits.each do |habit|
    log = today_logs[habit.id]
    if log&.is_taken?
      @completed_habits << { habit: habit, log: log }
    else
      @incomplete_habits << { habit: habit, log: log }
    end
  end
end
```

### 7.2 HabitsController の変更

```ruby
# app/controllers/habits_controller.rb

private

def habit_params
  params.require(:habit).permit(
    :name,
    :detail,
    :scheduled_time,
    schedule_days: []
  )
end
```

---

## 8. 実装フェーズ

### Phase 1: 曜日設定（先行リリース）

1. **DBマイグレーション**: `schedule_days` カラム追加
2. **モデル**: スコープ追加（`scheduled_for`）
3. **フォーム**: 曜日選択UI追加（新規・編集両方）
4. **コントローラー**: Strong Parameters 更新
5. **「今日の習慣」画面**: 基本実装（曜日フィルター適用）
6. **テスト**: モデル・コントローラー・システムテスト

### Phase 2: 時刻設定（Phase 1 完了後）

1. **DBマイグレーション**: `scheduled_time` カラム追加
2. **モデル**: スコープ追加（`ordered_by_time`）
3. **フォーム**: 時刻選択UI追加
4. **「今日の習慣」画面**: 時刻表示・並び順適用
5. **テスト**: 追加テスト

---

## 9. 受け入れ条件（AC）

### 必須
- [ ] Habit に対して実施曜日を設定できる
- [ ] Habit に対して実施時刻を設定できる（任意）
- [ ] 設定した曜日に応じて「今日の習慣」に表示が反映される
- [ ] 「今日の習慣」画面で未完了/完了がセクション分けされる
- [ ] 完了した習慣の記録を取り消せる
- [ ] 既存のワンタップ記録体験を壊さない
- [ ] 既存の習慣データが「今日の習慣」に表示される（毎日扱い）
- [ ] 主要ページでN+1が発生しない
- [ ] スマホ表示で崩れない

### 任意（あると良い）
- [ ] 曜日プリセットボタン（毎日/平日/週末）
- [ ] 時刻クリアボタン

---

## 10. スコープ外（将来課題）

以下は今回の実装範囲に含めない：

- プッシュ通知（時刻での通知送信）
- 複雑な繰り返しパターン（隔日、月3回など）
- カレンダーアプリ連携（iCal エクスポートなど）
- ユーザー別タイムゾーン設定
- 深夜帯の特別扱い（23:00〜02:00を同じ枠にするなど）

---

## 11. 技術的考慮事項

### 11.1 パフォーマンス
- `schedule_days` に GIN インデックスを作成（配列検索の高速化）
- N+1 回避のため `includes` を使用
- 今日のログは一括取得してメモリ内で分類

### 11.2 タイムゾーン
- `Asia/Tokyo` 固定（既存設定を維持）
- 「今日」の切替は 00:00 を基準

### 11.3 既存機能への影響
- 習慣一覧（/habits）: 変更なし（全習慣を表示）
- カレンダー画面: 変更なし
- 服用履歴: 変更なし
- ワンタップ記録: 変更なし

---

## 12. テスト方針

### 12.1 モデルテスト
- `scheduled_for` スコープの曜日フィルタリング
- `ordered_by_time` スコープの並び順
- 空配列/NULL の扱い

### 12.2 コントローラーテスト
- `todays_habits` アクションの習慣取得
- 完了/未完了の分類ロジック
- Strong Parameters の動作

### 12.3 システムテスト
- 曜日選択 UI の動作
- 時刻選択 UI の動作
- 「今日の習慣」画面の表示
- 記録/取り消しの動作

---

## 13. ヒアリング結果サマリ

| 項目 | 決定内容 |
|------|----------|
| ユーザー像 | 忘れ防止型 + 達成記録型の両方 |
| 主な利用シーン | 夜の振り返り |
| 時間帯の目的 | 並び順の整理 + 将来の通知用 |
| 曜日設定の動機 | 毎日じゃないものがある + やらない日を除外したい |
| 記録済みUI | 完了セクションへ移動（取消可能） |
| 曜日未設定時 | 毎日扱い |
| 複数回記録 | 不要（現状維持） |
| 時刻指定 | 最初から時刻（任意、30分刻み） |
| DB設計 | 配列カラム |
| 時刻入力UI | ドロップダウン（時間+分） |
| 曜日選択UI | トグルボタン + プリセット |
| 最優先事項 | 既存体験を崩さない、拡張性、パフォーマンス |
| 実装順序 | Phase 1: 曜日 → Phase 2: 時刻 |

---

*仕様確定日: 2026-01-26*
